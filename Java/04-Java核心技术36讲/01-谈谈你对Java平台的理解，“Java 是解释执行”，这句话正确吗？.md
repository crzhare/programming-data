# 谈谈你对Java平台的理解？“Java 是解释执行”，这句话正确吗？

谈谈你对 Java 平台的理解？“Java 是解释执行”，这句话正确吗？

---
## 1 典型回答

Java 本身是一种面向对象的语言，最显著的特性有两个方面：

- **书写一次，到处运行**（Write once, run anywhere），能够非常容易地获得**跨平台**能力。
- **垃圾收集**（GC, Garbage Collection），Java 通过垃圾收集器（Garbage Collector）回收分配内存，大部分情况下，程序员不需要自己操心内存的分配和回收。

日常接触到的 JRE 和 JDK

- JRE：Java 运行环境，包含了 JVM 和 Java 类库，以及一些模块等。
- JDK：可以看作是 JRE 的一个超集，提供了更多工具，比如编译器、各种诊断工具等。

对于“Java 是解释执行”这句话，这个说法不太准确：

- 运行 Java 的源代码，首先通过 Javac 编译成为字节码（bytecode）
- 在运行时，通过 Java 虚拟机（JVM）内嵌的解释器将字节码转换成为最终的机器码来执行，这是解释执行模式
- 除了解释执行之外，常见的 JVM，比如我们大多数情况使用的 Oracle JDK 提供的 Hotspot JVM，都提供了 **JIT（Just-In-Time）编译器**，也就是通常所说的**动态编译器**，JIT 能够在运行时将热点代码编译成机器码，这种情况下部分热点代码就属于编译执行，而不是解释执行了。
- 在 JVM 中，解释执行和编译执行是可以同时存在的

---
## 2 考点分析

其实这个问题，问得有点笼统。题目本身是非常开放的，往往考察的是多个方面，比如，基础知识理解是否很清楚；是否掌握 Java 平台主要模块和运行原理等。很多面试者会在这种问题上吃亏，稍微紧张了一下，不知道从何说起，就给出个很简略的回答。

对于这类笼统的问题，你需要尽量，表现出自己的思维深入并系统化，Java 知识理解得也比较全面，，一定要避免让面试官觉得你是个“知其然不知其所以然”的人。毕竟明白基本组成和机制，是日常工作中进行问题诊断或者性能调优等很多事情的基础，相信没有招聘方会不喜欢“热爱学习和思考”的面试者。

即使感觉自己的回答不是非常完善，也不用担心。我个人觉得这种笼统的问题，有时候回答得稍微片面也很正常，大多数有经验的面试官，不会因为一道题就对面试者轻易地下结论。通常会尽量引导面试者，把他的真实水平展现出来，这种问题就是做个开场热身，面试官经常会根据你的回答扩展相关问题。

---
## 3 对 Java 平台的理解

对于 Java 平台的理解，可以从很多方面简明扼要地谈一下：

- **Java 语言特性**:包括泛型、Lambda 等语言特性；基础类库，包括集合、IO/NIO、网络、并发、安全等基础类库。
- **JVM 的一些基础概念和机制**：
 - Java 的类加载机制，JDK 内嵌的 Class-Loader，例如 `Bootstrap、 Application 和 Extension Class-loader`
 - 类加载大致过程：`加载、验证、链接、初始化`；自定义 Class-Loader 等。
 - 垃圾收集的基本原理。
 - 最常见的垃圾收集器，如 `SerialGC、Parallel GC、 CMS、 G1` 等。
 - 不同垃圾收集器适用于什么样的工作负载。
- **JDK 工具 和 Java 领域内其他工具**:如编译器、运行时环境、安全工具、诊断和监控工具等。这些基本工具是日常工作效率的保证。

![](index_files/20180513233854.png)

---
## 4 解释执行和编译执行细节

通常把 Java 分为**编译期和运行时**。这里说的 Java 的编译和 C/C++ 是有着不同的意义的，Javac 的编译，编译 Java 源码生成“.class”文件里面实际是字节码，而不是可以直接执行的机器码。**Java 通过字节码和 Java 虚拟机（JVM）这种跨平台的抽象，屏蔽了操作系统和硬件的细节，这也是实现“一次编译，到处执行”的基础。**

###  混合模式

运行时，JVM 会通过类加载器（Class-Loader）加载字节码，解释或者编译执行。主流 Java 版本中，如 JDK 8 实际是**解释和编译混合**的一种模式，即所谓的**混合模式（-Xmixed）**。Oracle Hotspot JVM 内置了两个不同的 JIT compiler：C1 和 C2

 - client 模式，适用于对于启动速度敏感的应用，比如普通 Java 桌面应用，C1 用于 client 模式
 - server 模式，它的优化是为长时间运行的服务器端应用设计的。默认是采用所谓的分层编译（TieredCompilation）。C 适用于 server 模式

### 通过 JVM 参数指定运行模型

Java 虚拟机启动时，可以指定不同的参数对运行模式进行选择。比如：

- 指定`“-Xint”`，就是告诉 JVM 只进行解释执行，不对代码进行编译，这种模式抛弃了 JIT 可能带来的性能优势。毕竟解释器（interpreter）是逐条读入，逐条解释运行的。
- 指定`“-Xcomp”`参数，这是告诉 JVM 关闭解释器，不要进行解释执行，或者叫作最大优化级别。

但`“-Xcomp”`并一定就是最高效的，原因在于`“-Xcomp”`会导致 JVM 启动变慢非常多，同时有些 JIT 编译器优化方式，比如分支预测，如果不进行 profiling，往往并不能进行有效优化。所以并不是这种模式就一定是最高效的。

###  AOT 模式

除了我们日常最常见的 Java 使用模式，其实还有一种新的编译方式，即所谓的 AOT（Ahead-of-Time Compilation），直接将字节码编译成机器代码，这样就避免了 JIT 预热等各方面的开销，比如 Oracle JDK 9 就引入了实验性的 AOT 特性，并且增加了新的 jaotc 工具。利用下面的命令把某个类或者某个模块编译成为 AOT 库。

```
//编译命令
jaotc --output libHelloWorld.so HelloWorld.class
jaotc --output libjava.base.so --module java.base

//在启动时直接指定运行so
java -XX:AOTLibrary=./libHelloWorld.so,./libjava.base.so HelloWorld
```

Oracle JDK 支持分层编译和 AOT 协作使用，这两者并不是二选一的关系。

###  JVM 是一个强大的平台

JVM 作为一个强大的平台，不仅仅只有 Java 语言可以运行在 JVM 上，**本质上合规的字节码都可以运行**，Java 语言自身也为此提供了便利，我们可以看到类似 `Clojure、Scala、Groovy、JRuby、Jython、Kotlin` 等大量 JVM 语言，活跃在不同的场景。

---
## 4 总结与思考题

今天，我简单介绍了一下 Java 平台相关的一些内容，目的是提纲挈领地构建一个整体的印象，包括 Java 语言特性、 核心类库与常用第三方类库、Java 虚拟机基本原理和相关工具，希望对你有所帮助。

关于今天我们讨论的题目你做到心中有数了吗？知道不如做到，请你也在留言区写写自己对 Java 平台的理解。我会选出经过认真思考的留言，送给你一份学习鼓励金，欢迎你与我一起讨论。

### 谈谈你对Java平台的理解？

- 掌握 Java 语言核心类库
- 掌握 Java 编译器、JVM运行机制
- 熟练运行 JDK 中提供的各种工具
- Java 现在是一个生态，class 字节码和 JVM 是核心
- 一般情况下，java 编程是面向 JVM 编程，JVM 就是一个虚拟的 CPU

### “Java 是解释执行”，这句话正确吗？

- Java 不是变异机制，是解释机制
- Java 不仅仅是解释执行，还包括 JIT 即时编译执行，二者这两种模式是可以同时存在的
- 通过 JVM 参数可以指定 JVM 的运行模式
- JDK 9 提供了 AOT 模式，直接将 java 代码编译为机器码


### 从宏观角度和围观角度看 Java 平台

#### 宏观角度

Java 跟 c/c++ 最大的不同点在于，**c/c++编程是面向操作系统的**，需要开发者极大地关心不同操作系统之间的差异性；而Java平台通过虚拟机屏蔽了操作系统的底层细节，使得开发者无需过多地关心不同操作系统之间的差异性。**通过增加一个间接的中间层来进行”解耦“是计算机领域非常常用的一种”艺术手法“**，虚拟机是这样，操作系统是这样，HTTP也是这样。

Java平台已经形成了一个**生态系统**，在这个生态系统中，有着诸多的研究领域和应用领域：

1. 虚拟机、编译技术的研究(例如：GC优化、JIT、AOT等)：对效率的追求是人类的另一个天性之一
2. Java语言本身的优化
3. 大数据处理
4. Java并发编程
5. 客户端开发（例如：Android平台）

#### 微观角度

Java平台中有两大核心：

1. Java语言本身、JDK中所提供的核心类库和相关工具
 - 对语言本身的了解，需要开发者非常熟悉语言的语法结构；而Java又是一种面对对象的语言，这又需要开发者深入了解面对对象的设计理念；
 - Java核心类库包含集合类、线程相关类、IO、NIO、JUC并发包等；
 - JDK提供的工具包含：基本的编译工具、虚拟机性能检测相关工具等。
2. Java虚拟机以及其他包含的GC
 - 大部分情况下，编程者只需要关心Java语言本身，而无需特意关心底层细节。包括对内存的分配和回收，也全权交给了GC。
 - 对于虚拟机而言，只要是符合规范的字节码，它们都能被加载执行。

### 一次编译、到处运行

“一次编译、到处运行”说的是Java语言跨平台的特性，Java的跨平台特性与Java虚拟机的存在密不可分，可在不同的环境中运行。比如说Windows平台和Linux平台都有相应的JDK，安装好JDK后也就有了Java语言的运行环境。其实Java语言本身与其他的编程语言没有特别大的差异，并不是说Java语言可以跨平台，而是在不同的平台都有可以让Java语言运行的环境而已，所以才有了Java一次编译，到处运行这样的效果。严格的讲，跨平台的语言不止Java一种，但Java是较为成熟的一种。“一次编译，到处运行”这种效果跟编译器有关。编程语言的处理需要编译器和解释器。Java虚拟机和DOS类似，相当于一个供程序运行的平台。程序从源代码到运行的三个阶段：`编码——>编译——>运行——>调试`。Java在编译阶段则体现了跨平台的特点。编译过程大概是这样的：首先是将Java源代码转化成.CLASS文件字节码，这是第一次编译。`.class`文件就是可以到处运行的文件。然后Java字节码会被转化为目标机器代码，这是是由JVM来执行的，即Java的第二次编译。**“到处运行”的关键和前提就是JVM**。因为在第二次编译中JVM起着关键作用。在可以运行Java虚拟机的地方都内含着一个JVM操作系统。从而使JAVA提供了各种不同平台上的虚拟机制，因此实现了“到处运行”的效果。需要强调的一点是，**java并不是编译机制，而是解释机制**。Java字节码的设计充分考虑了JIT这一即时编译方式，可以将字节码直接转化成高性能的本地机器码，这同样是虚拟机的一个构成部分。