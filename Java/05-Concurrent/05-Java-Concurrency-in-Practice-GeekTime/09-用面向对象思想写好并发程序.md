# 用面向对象思想写好并发程序

面向对象思想与并发编程本身并没有关系，它们属于不同的领域。在 Java 语言里，面向对象思想与并发编程本身可以很好的融合，面向对象思想能够让并发编程变得更简单。主要可以从三个方面入手：

1. 封装共享变量
2. 识别共享变量间的约束条件
3. 制定并发访问策略

## 1 封装共享变量

- 并发程序，我们关注的一个核心问题是**解决多线程同时访问共享变量的问题**。
- 面向对象思想的一个重要的特性是封装，封装就是**将属性和实现细节封装在对象内部，外界对象只能通过目标对象提供的公共方法来间接访问这些内部属性**。这样就杜绝了外部直接访问共享变量的可能。
- 利用面向对象思想写并发程序的思路就是：**将共享变量作为对象属性封装在内部，对所有公共方法制定并发访问策略**。
- 在对象内部，**对于那些不会发生变化的共享变量，应该使用用 final 关键字来修饰**。这样既能避免并发问题，也能很明了地表明你的设计意图。

## 2 识别共享变量间的约束条件

识别共享变量间的约束条件，决定了并发访问策略。在设计阶段，我们一定要识别出所有共享变量之间的约束条件，如果约束条件识别不足，很可能导致制定的并发访问策略南辕北辙。

比如，下面库存管理类，就忽略了库存上线与库存下线之间的约束条件，错用了并发工具：

```java
public class SafeWM {

  // 库存上限
  private final AtomicLong upper = new AtomicLong(0);

  // 库存下限
  private final AtomicLong lower = new AtomicLong(0);

  // 设置库存上限
  void setUpper(long v){
    // 检查参数合法性
    if (v < lower.get()) {
      throw new IllegalArgumentException();
    }
    upper.set(v);
  }

  // 设置库存下限
  void setLower(long v){
    // 检查参数合法性
    if (v > upper.get()) {
      throw new IllegalArgumentException();
    }
    lower.set(v);
  }

  // 省略其他业务代码
}
```

## 3 制定并发访问策略

制定并发访问策略，关注三个点：

1. **避免共享**：避免共享的技术主要是利于线程本地存储以及为每个任务分配独立的线程。
2. **不变模式**：这个在 Java 领域应用的很少，但在其他领域却有着广泛的应用，例如 Actor 模式、CSP 模式以及函数式编程的基础都是不变模式。
3. **管程及其他同步工具**：Java 领域万能的解决方案是管程，但是对于很多特定场景，使用 Java 并发包提供的读写锁、并发容器等同步工具会更好。

掌握以下宏观原则，有助于写出“健壮”的并发程序。

1. **优先使用成熟的工具类**：Java SDK 中已经提供了很多成熟的并发工具，它们是我们解决并发问题的首选。
2. **迫不得已时才使用低级的同步原语**：低级的同步原语主要指的是 `synchronized、Lock、Semaphore` 等，如果有封装完善的工具类，我们可以优先考虑。
3. **避免过早优化**：
   1. 安全第一，并发程序首先要保证安全，出现性能瓶颈后再优化。
   2. 在设计期和开发期，很多人经常会情不自禁地预估性能的瓶颈，并对此实施优化，但残酷的现实却是：性能瓶颈不是你想预估就能预估的。
