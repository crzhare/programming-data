# 互动直播App开发

[教程地址](http://coding.imooc.com/class/143.html)

---
## 1 直播基础知识

2016年直播基础元年

- 基础条件成熟：网络、软硬件、弹幕文化
- 人性驱动
- 实时互动

直播盈利：

- 观众送礼
- 主播商品广告
- 付费直播

### 直播特点

点播：

- 视频网址
- 文件存储在服务器上
- 指定节目

直播：

- 直播网址看主播
- 数据实时发送

### 直播流程

分为四个端：

- 推流端：采集 -> 前处理(美颜) -> 直播数据编码 -> 推流
- 服务端：转码 -> 录制 -> 截图 -> 鉴黄
- 播放端：拉流 -> 解码 -> 渲染
- 互动系统：聊天、礼物、点赞

### 直播流程——采集

#### 简介

音频采集：

- 采样率
- 位宽
- 声道
- 音频帧

计算：采样率=8kHz、双声道、位宽=16bit、20ms为一帧，则一帧的数据为：`8000 * 2 * 16 * 0.02 = 640byte`

图像采集：

- 分辨率
- 采样频率
- 采集格式
- 传输通道

采集源：

- 摄像头
- 屏幕录制
- 文件推流

#### 采集平台技术

- Android采集：setPreviewCallback、MediaRecorder
- IOS采集：AVFoundation.framework
- PC采集：mjpeg、摄像头

### 直播流程——前处理

视频处理：

- 美颜：识别皮肤，调整色值
- 磨皮：模糊处理
- 滤镜：GPUImage库
- 水印：图像与水印合并

音频处理：

- 混音：音频信号的叠加，采样值溢出的处理
- 降噪：傅里叶变换，提高声音辨识度
- 特效：音色、音调、SoundTouch、FFmod

### 直播流程——编码和封装

编码的必要性：采集的视频流非常占空间(比如YUV)，通过编码压缩数据存储空间，减少传输时间

编码的原理：

- 空间冗余：相邻像素之间的相关性
- 时间冗余：相邻图像之间的相关性
- 编码冗余：像素值出现的概率不同
- 视觉冗余：视觉对细节的不敏感性

常见图像编码器：

- H264
- H265
- VP8
- VP9

H264编码知识：

- NALU：网络提取单元
- SPS：包括了一个图像序列的所有信息
- PPS：包括了一个图像所有的片的信息
- I帧：帧内编码帧
- P帧：前向预测编码帧
- B帧：双向预测编码帧
- GOP：两个I帧之间的图像组

常见音频编码器：ACC、PCM、WAV、OGG

常见音频封装格式：FLV、TS、AVI

### 直播流程——推送与优化

RTMP协议：实时消息传输协议

- CDN支持良好
- 协议简单、容易实现
- 基于TCP，传输成本高
- 浏览器不支持
- Adobe私有协议

WebRTC协议：

- W3C标准
- 基于UDP
- 弱网时序可能错乱
- CDN支持较差

UDP自定义：

- 定制化空间大
- 开发成本高
- CDN不友好

优化思路：

- 保证音频的传输(弱网下)
- 根据带宽调整码率、FPS、分辨率
- 减少传输的数据(I帧丢了，其他帧就没必要发了，暂时的卡顿)

### 直播流程——服务端

- 转码：即先解码再编码，适应不同的网络带宽、不同的终端处理能力和不同用户需求为直播平台提供很多增值服务。
- 实时转码：高计算负荷
- 录制、截图
- 鉴黄：基于深度学习的图片识别技术，对直播流进行控制

### 直播流程——播放

常见拉流协议

- RTMP：适用于技术性要求高，或有互动需求
- HTTP-FLV：同上
- HLS：适用于有回放需求，或跨平台直播

解码

- 编码的逆过程
- 从音视频的数据中提取原始数据

渲染：视频画片和声音的播放

### 直播流程——交互

- 聊天
- 礼物

### 辅助工具

推流端——OBS Studio：

- 支持桌面和文件推流
- 支持多画面、多音频混合推流
- 支持录制
- 开源

播放端——CUTV测试工具

- 流信息展示丰富
- 可设置缓存时间(测试延迟)
- 网页
- 地址：`http://www.cutv.com/demo/live_test.swf`

播放端——VLC

其他辅助工具：

- Softe AAC Converter：转化为aac音频
- H264BSAnalyzer：分析H264视频格式
- FlvParse：分析FLV文件
- yuvplayer：播放YUV文件

---
## 2 需求分析

### 需求列表

- 通用模块
  - 设置
  - 密码相关
  - 登录、注册
- 直播模块
  - 充值
  - 直播列表
  - 观众端
  - 主播端

### 基础模块选型

- 网络交互：OKHttp、Retrofit
- 图片加载：Glide
- 用户信息存储：七牛云存储
- 聊天通讯：第三方
- 直播/播放：第三方
- 界面元素：自己开发、github

---
## 3 直播系统选型

### IM系统

选择标准：

- 稳定性：不丢消息
- 安全：账号、信息，数据导入、防盗号
- 端支持：是否全面
- 技术支持：响应开，反馈渠道多
- 用户规模：越大越好，很多坑已经被填
- 性价比：收费测量、免费额度

IM平台对比

NA | LenanCloud | 融云 | 环信 | 云信 | <font color='red'>腾讯IM</font>
--- | --- | --- | --- | --- | ---
稳定性| 4星 | 4星 | 4星 | 4星 | 4星
安全性| 未知 | 消息加密 | 数据加密 | 账号托管、消息加密 | 账号托管、消息加密
端支持|A、I、WP、J|A、I、Web|A、I、W、Web、Linux|A、I、W、Web、Unity|A、I、W、Web
技术支持|社区|工单|社区、工单|无人工支持|工单、社区、qq群
用户规模|1W+|未知|8W+|未知|1W+
免费额度|500人/天|基础功能|日活30W|100个账号|日货10万

### 直播系统

选择标准：

- 稳定性：弱网环境下
- 功能性：参数可配置、功能丰富(美颜、滤镜)
- 端支持：全面
- 收费策略

直播平台对比

NA | 金山云 | 七牛云 | 阿里云 |   <font color='red'>腾讯云：互动直播</font>
--- | --- | --- | --- | ---
稳定|上行速度|动态码率|追帧播放|通道选路智能化
功能|美颜连麦、短视频录制|美颜滤镜、连麦互动、实时录制|美颜连麦、纯音频|美颜滤镜、连麦
端支持|I、A|I、A|I、A|I、A、W
价格|未知|未知|峰值带宽|基础网络费用、附加功能费用、技术支持费用
包大小(M)|5.5+8|1.9+4.8|3.8+9.9|12

---
## 4 互动直播App开发

1. 腾讯SDK功能
   - 登录注册、账号管理
   - IM
   - 互动直播
2. 图片上传到七牛云，图片上传成功后返回图片URL，将URL更新到腾讯后台
3. 后台开发与数据库设计
   - 直播房间列表
   - 用户直播信息表
   - [魔泊云](https://www.mopaas.com)

---
## 5 总结

通过使用第三方SDK，可以很快的开发出一款直播互动SDK。
